<!DOCTYPE html>
<html lang="sl"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINDEX - E-Dnevnik</title>
    <style>
        /* --- STIL (WINDOWS RETRO) --- */
        :root {
            --win-gray: #d4d0c8;
            --win-dark: #808080;
            --win-light: #ffffff;
            --win-text: #000000;
            --win-blue: #0a246a;
            --split-gray: #b0b0b0; /* Temnejša siva za spodnji del celice */
        }

        body {
            font-family: 'Tahoma', 'Segoe UI', sans-serif;
            background-color: var(--win-gray);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* Utility */
        .hidden { display: none !important; }
        .bold { font-weight: bold; }
        
        /* Gumbi */
        .win-btn {
            background: var(--win-gray);
            border: 2px solid;
            border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light);
            padding: 4px 12px;
            cursor: pointer;
            font-family: inherit;
            min-width: 70px;
        }
        .win-btn:active {
            border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark);
            transform: translate(1px, 1px);
        }

        /* Layout */
        .layout-container { display: flex; width: 100%; height: 100%; }
        
        /* STRANSKI MENI */
        .sidebar {
            width: 180px;
            background: white;
            border-right: 2px solid black;
            display: flex;
            flex-direction: column;
            padding-top: 20px;
            align-items: center; 
        }

        .sidebar-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-bottom: 10px;
            width: 150px; 
            height: auto; 
            display: block;
        }
        
        .sidebar-btn img {
            width: 100%;
            height: auto;
            display: block;
            border: 1px solid #ccc;
        }
        .sidebar-btn img:active { transform: translate(1px, 1px); }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; }

        /* Header */
        .top-header {
            height: 80px;
            background: #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #999;
        }
        .app-title { font-size: 48px; font-family: 'Arial', sans-serif; letter-spacing: 2px; }
        .time-info, .session-info { font-weight: bold; font-size: 14px; }

        .content-body { padding: 20px; overflow-y: auto; background: white; height: 100%; }

        /* Login page elements */
        #login-page { display: flex; width: 100%; height: 100%; background: white; }
        .login-box {
            background: #c0c0c0; padding: 20px; width: 350px;
            margin-top: 20px; border: 2px solid #808080;
        }
        .login-input { width: 90%; padding: 5px; margin-bottom: 10px; border: 2px inset #808080; }
        .last-login-box {
            background: #dcdcdc; padding: 10px; margin-top: 20px; width: 350px;
            border: 1px solid #999; display: flex; justify-content: space-between; align-items: center;
        }

        /* Info bar */
        .info-bar {
            background: #e0e0e0; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #ccc; font-size: 18px; font-weight: bold;
        }
        .logout-icon-btn { cursor: pointer; height: 50px; width: auto; vertical-align: middle; margin-left: 10px; }
        .logout-icon-btn:hover { opacity: 0.8; }

        /* Gradebook Table */
        .gradebook-table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 2px solid black; }
        /* Odstranjen padding na td, da split-view deluje pravilno. Padding dodamo v notranje div-e */
        .gradebook-table th { border: 1px solid black; padding: 5px; text-align: center; vertical-align: middle; height: 30px; background: #eee; }
        .gradebook-table td { border: 1px solid black; text-align: center; vertical-align: middle; height: 40px; padding: 0; }
        
        .grade-cell { cursor: pointer; min-width: 50px; height: 100%; position: relative; }
        .grade-cell:hover { background-color: #ffffcc; }
        
        /* NOVO: Split View Styles */
        .split-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 46px; /* Da je celica dovolj visoka */
            width: 100%;
        }
        .split-top {
            flex: 1;
            background-color: white;
            border-bottom: 1px dotted #999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            padding: 2px;
        }
        .split-bottom {
            flex: 1;
            background-color: var(--split-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            padding: 2px;
        }
        /* Če ni split view, uporabimo to za poravnavo */
        .single-view {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            height: 100%;
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        /* Grade Styles */
        .grade-span { margin: 0 3px; position: relative; display: inline-block; }
        .grade-pisno { color: red; font-weight: bold; }
        .grade-ustno { color: black; font-weight: bold; }
        .grade-izdelek { color: blue; font-weight: bold; }
        .grade-correction { font-size: 0.7em; vertical-align: sub; margin-right: 3px; }
        
        .icon-img { height: 24px; width: auto; vertical-align: middle; }

        .grade-type-btn { margin: 10px 5px; font-size: 13px; padding: 3px 10px; }
        .selected-type { background-color: #a0a0a0; border-style: inset; }

        /* --- UNIVERZALNI MODALNI SISTEM --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .win-window {
            background: var(--win-gray);
            border: 2px solid;
            border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light);
            padding: 3px;
            width: 450px;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }
        .win-header {
            background: var(--win-blue); color: white; padding: 4px 6px;
            font-weight: bold; font-size: 14px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .win-close {
            background: var(--win-gray); color: black; border: 1px outset white;
            font-size: 12px; line-height: 12px; padding: 2px 4px; cursor: pointer;
        }
        .win-close:active { border-style: inset; }

        .win-body {
            padding: 15px;
            font-size: 14px;
        }
        .win-body label { display: block; margin-top: 10px; margin-bottom: 2px; }
        .win-body input, .win-body select { width: 95%; padding: 3px; border: 2px inset #fff; }
        
        .win-footer {
            padding: 10px;
            text-align: right;
            border-top: 1px solid #999;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Seznami za admina */
        .admin-list { list-style: none; padding: 0; border: 2px inset white; background: white; max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
        .admin-list li { padding: 3px; border-bottom: 1px dotted #ccc; display: flex; justify-content: space-between; align-items: center; }
        .admin-list li:hover { background: #e0e0ff; }
        .mini-btn { font-size: 11px; padding: 1px 4px; margin-left: 3px; }

    </style>
</head>
<body>

    <div id="login-page">
        <div class="sidebar">
            <button class="sidebar-btn"><img src="redovalnica_sivo.png" onmouseover="this.src='redovalnica_barve.png'" onmouseout="this.src='redovalnica_sivo.png'"></button>
            <button class="sidebar-btn"><img src="profil_sivo.png" onmouseover="this.src='profil_barve.png'" onmouseout="this.src='profil_sivo.png'"></button>
            <button class="sidebar-btn"><img src="podatki_sivo.png" onmouseover="this.src='podatki_barve.png'" onmouseout="this.src='podatki_sivo.png'"></button>
            <button class="sidebar-btn"><img src="odjava_sivo.png" onmouseover="this.src='odjava_barve.png'" onmouseout="this.src='odjava_sivo.png'"></button>
            <button class="sidebar-btn"><img src="domov_sivo.png" onmouseover="this.src='domov_barve.png'" onmouseout="this.src='domov_sivo.png'"></button>
        </div>
        <div class="main-content">
            <div class="top-header">
                <div></div> <div class="app-title">MINDEX</div> <div></div>
            </div>
            <div class="content-body">
                <h2>Podatki:</h2>
                <div style="background: #dcdcdc; padding: 10px; margin-bottom: 20px; width: 350px; border: 1px solid gray;">
                    Številka licence: <span class="bold">avtomatsko vnese</span><br>
                    IP naslov naprave: <span class="bold">avtomatsko vnese</span>
                </div>

                <h2>Prijava v sistem:</h2>
                <div class="login-box">
                    <input type="text" id="login-username" class="login-input" placeholder="Uporabniško ime"><br>
                    <input type="password" id="login-password" class="login-input" placeholder="Geslo"><br>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="win-btn bold" onclick="handleLogin()">POTRDI</button>
                    </div>
                </div>

                <h2>Zadnja prijava kot:</h2>
                <div class="last-login-box">
                    <div style="font-size: 13px;">
                        Uporabnik: <span id="last-login-user" class="bold"></span><br>
                        Datum: <span id="last-login-time" class="bold"></span>
                    </div>
                    <button class="win-btn bold" onclick="fillLastLogin()">Uporabi</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard-page" class="layout-container hidden">
        <div class="sidebar">
            <button class="sidebar-btn" onclick="showPage('redovalnica')"><img src="redovalnica_sivo.png" onmouseover="this.src='redovalnica_barve.png'" onmouseout="this.src='redovalnica_sivo.png'"></button>
            <button class="sidebar-btn" onclick="showProfile()"><img src="profil_sivo.png" onmouseover="this.src='profil_barve.png'" onmouseout="this.src='profil_sivo.png'"></button>
            <button class="sidebar-btn" onclick="checkAdminAndShowData()"><img src="podatki_sivo.png" onmouseover="this.src='podatki_barve.png'" onmouseout="this.src='podatki_sivo.png'"></button>
            <button class="sidebar-btn" onclick="handleLogout()"><img src="odjava_sivo.png" onmouseover="this.src='odjava_barve.png'" onmouseout="this.src='odjava_sivo.png'"></button>
            <button class="sidebar-btn" onclick="showPage('home')"><img src="domov_sivo.png" onmouseover="this.src='domov_barve.png'" onmouseout="this.src='domov_sivo.png'"></button>
        </div>

        <div class="main-content">
            <div class="top-header">
                <div class="session-info">
                    Seja poteče čez:<br>
                    <span id="session-timer" class="bold"></span>
                </div>
                <div class="app-title">MINDEX</div>
                <div class="time-info">
                    Ura je:<br>
                    <span id="clock" class="bold"></span>
                </div>
            </div>

            <div class="info-bar">
                <div>
                    Pozdravljeni, <br>
                    <span id="teacher-name-display" style="text-transform: uppercase;"></span>
                </div>
                <img src="odjava_ikona_barvno.png" class="logout-icon-btn" onclick="handleLogout()" alt="Odjava">
            </div>

            <div id="content-area" class="content-body">
                <div id="view-home" class="view-section hidden">
                    <div style="text-align: center; margin-top: 50px;">
                        <img src="redovalnica_barve.png" style="height: 50px; margin: 10px;"> REDOVALNICA<br>
                        <img src="podatki_barve.png" style="height: 50px; margin: 10px;"> PODATKI<br>
                        <img src="profil_barve.png" style="height: 50px; margin: 10px;"> PROFIL
                    </div>
                </div>

                <div id="view-redovalnica" class="view-section">
                    <h3>Redovalnica</h3>
                    <div style="margin-bottom: 20px;">
                        <label>Razred:</label>
                        <select id="sel-class" onchange="renderGradebook()" style="padding: 3px;"><option value="">Izberi razred</option></select>
                        
                        <label style="margin-left: 20px;">Predmet:</label>
                        <select id="sel-subject" onchange="renderGradebook()" style="padding: 3px;"><option value="">Izberi predmet</option></select>

                        <label style="margin-left: 20px;">Pogled:</label>
                        <select id="sel-view" onchange="renderGradebook()" style="padding: 3px;">
                            <option value="TEACHERS" selected>UČITELJI</option>
                            <option value="STUDENTS">UČENCI</option>
                        </select>
                    </div>

                    <table class="gradebook-table">
                        <thead>
                            <tr>
                                <th width="20%">Učenec</th>
                                <th width="25%">1. Ocenjevalno obdobje</th>
                                <th width="5%"><img src="graja.png" alt="Graja" style="height:20px;"></th>
                                <th width="25%">2. Ocenjevalno obdobje</th>
                                <th width="5%"><img src="graja.png" alt="Graja" style="height:20px;"></th>
                                <th width="10%">Končna</th>
                            </tr>
                        </thead>
                        <tbody id="gradebook-body">
                            </tbody>
                    </table>

                    <div style="margin-top: 10px;">
                        Izberi način vnosa:
                        <button class="win-btn btn-pisno grade-type-btn" onclick="setGradeType('PISNO')">PISNO</button>
                        <button class="win-btn btn-ustno grade-type-btn" onclick="setGradeType('USTNO')">USTNO</button>
                        <button class="win-btn btn-izdelek grade-type-btn" onclick="setGradeType('IZDELEK')">IZDELEK</button>
                    </div>
                    
                    <hr>
                    <button class="win-btn" onclick="openBulkEntry()">MNOŽIČNO VPIŠI</button>
                </div>

                <div id="view-podatki" class="view-section hidden">
                    <h3>Administracija podatkov</h3>
                    <div class="win-border" style="padding: 10px; margin-bottom: 10px;">
                        <h4>SEZNAM UČITELJEV</h4>
                        <ul id="list-teachers" class="admin-list"></ul>
                        <button class="win-btn" onclick="addTeacher()">Dodaj učitelja</button>
                    </div>
                    <div class="win-border" style="padding: 10px; margin-bottom: 10px;">
                        <h4>SEZNAM RAZREDOV</h4>
                        <ul id="list-classes" class="admin-list"></ul>
                        <button class="win-btn" onclick="addClass()">Dodaj razred</button>
                    </div>
                    <div class="win-border" style="padding: 10px; margin-bottom: 10px;">
                        <h4>SEZNAM PREDMETOV</h4>
                        <ul id="list-subjects" class="admin-list"></ul>
                        <button class="win-btn" onclick="addSubject()">Dodaj predmet</button>
                    </div>
                    <button class="win-btn" style="background: #ffcccc;" onclick="resetAllData()">PONASTAVI VSE (Reset)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-container"></div>

<script>
/**
 * MINDEX APLIKACIJA - SPREMENJENA LOGIKA (Split View + Tooltips + Authors)
 */

const DEFAULT_ADMIN = { id: 1, name: 'Administrator', username: 'ADMIN', password: 'ADMIN', role: 'admin', sessionTimeout: 30 };
let db = {
    users: [DEFAULT_ADMIN],
    classes: [], 
    subjects: [], 
    grades: [], 
    warnings: [], 
    lastLogin: { user: '', time: '' }
};

let currentState = {
    user: null,
    selectedGradeType: 'USTNO', 
    selectedClassId: null,
    selectedSubjectId: null,
    sessionInterval: null,
    sessionTime: 0 
};

// --- MODALNI SISTEM ---
function closeModal() {
    document.getElementById('modal-container').innerHTML = '';
}

function showModal(title, htmlContent, buttons = []) {
    const container = document.getElementById('modal-container');
    
    let btnsHtml = '';
    if (buttons.length === 0) {
        buttons = [{ label: 'V redu', onClick: closeModal }];
    }
    
    buttons.forEach((btn, index) => {
        btnsHtml += `<button class="win-btn" id="modal-btn-${index}">${btn.label}</button>`;
    });

    container.innerHTML = `
        <div class="modal-overlay">
            <div class="win-window">
                <div class="win-header">
                    <span>${title}</span>
                    <span class="win-close" id="modal-x-close">X</span>
                </div>
                <div class="win-body">
                    ${htmlContent}
                </div>
                <div class="win-footer">
                    ${btnsHtml}
                </div>
            </div>
        </div>
    `;

    document.getElementById('modal-x-close').onclick = closeModal;
    buttons.forEach((btn, index) => {
        document.getElementById(`modal-btn-${index}`).onclick = function() {
            if (btn.onClick) btn.onClick();
            if (btn.shouldClose !== false) closeModal();
        };
    });
}

function customAlert(message) {
    showModal("Obvestilo", `<p>${message}</p>`, [{label: 'V redu', onClick: closeModal}]);
}

function customConfirm(message, onConfirm) {
    showModal("Potrditev", `<p>${message}</p>`, [
        { label: 'Potrdi', onClick: onConfirm },
        { label: 'Prekliči', onClick: closeModal }
    ]);
}

function customPrompt(message, onResult) {
    const html = `<label>${message}</label><input type="text" id="prompt-input" autofocus>`;
    showModal("Vnos podatka", html, [
        { 
            label: 'Potrdi', 
            onClick: () => {
                const val = document.getElementById('prompt-input').value;
                onResult(val);
            }
        },
        { label: 'Prekliči', onClick: closeModal }
    ]);
}

// --- INIT ---
function init() {
    const saved = localStorage.getItem('mindex_db');
    if (saved) db = JSON.parse(saved);
    else saveDB();
    
    updateClock();
    setInterval(updateClock, 1000);
    
    if(db.lastLogin.user) {
        document.getElementById('last-login-user').innerText = db.lastLogin.user;
        document.getElementById('last-login-time').innerText = db.lastLogin.time;
    }
}

function saveDB() {
    localStorage.setItem('mindex_db', JSON.stringify(db));
}

// --- CLOCK & SESSION ---
function updateClock() {
    const now = new Date();
    const clockEl = document.getElementById('clock');
    if (clockEl) clockEl.innerText = now.toLocaleTimeString('sl-SI');
}

function startSessionTimer() {
    const minutes = currentState.user.sessionTimeout || 15;
    currentState.sessionTime = minutes * 60;
    
    if (currentState.sessionInterval) clearInterval(currentState.sessionInterval);
    
    currentState.sessionInterval = setInterval(() => {
        currentState.sessionTime--;
        if (currentState.sessionTime <= 0) {
            handleLogout();
            const html = `
                <div style="display:flex; align-items:center; justify-content:center;">
                    <img src="odjava_ikona_barvno.png" style="height:50px; width:auto; margin-right:15px;">
                    <span>Seja je potekla, potrebna je ponovna prijava.</span>
                </div>
            `;
            showModal("Obvestilo", html, [{label: 'V redu', onClick: closeModal}]);
        } else {
            const h = Math.floor(currentState.sessionTime / 3600);
            const m = Math.floor((currentState.sessionTime % 3600) / 60);
            const s = currentState.sessionTime % 60;
            document.getElementById('session-timer').innerText = 
                `${h.toString().padStart(2,'0')} : ${m.toString().padStart(2,'0')} : ${s.toString().padStart(2,'0')}`;
        }
    }, 1000);
}

// --- LOGIN / LOGOUT ---
function handleLogin() {
    const u = document.getElementById('login-username').value;
    const p = document.getElementById('login-password').value;
    
    const user = db.users.find(x => x.username === u && x.password === p);
    
    if (user) {
        currentState.user = user;
        db.lastLogin = { user: u, time: new Date().toLocaleString('sl-SI') };
        saveDB();
        
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('dashboard-page').classList.remove('hidden');
        document.getElementById('teacher-name-display').innerText = user.name;
        
        startSessionTimer();
        showPage('home');
    } else {
        customAlert("Napačno uporabniško ime ali geslo!");
    }
}

function handleLogout() {
    currentState.user = null;
    clearInterval(currentState.sessionInterval);
    document.getElementById('dashboard-page').classList.add('hidden');
    document.getElementById('login-page').classList.remove('hidden');
    document.getElementById('last-login-user').innerText = db.lastLogin.user;
    document.getElementById('last-login-time').innerText = db.lastLogin.time;
    document.getElementById('login-username').value = "";
    document.getElementById('login-password').value = "";
}

function fillLastLogin() {
    if(db.lastLogin.user) document.getElementById('login-username').value = db.lastLogin.user;
}

// --- NAVIGATION ---
function showPage(pageId) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
    if (pageId === 'home') document.getElementById('view-home').classList.remove('hidden');
    if (pageId === 'redovalnica') {
        document.getElementById('view-redovalnica').classList.remove('hidden');
        loadRedovalnicaDropdowns();
    }
    if (pageId === 'podatki') {
        document.getElementById('view-podatki').classList.remove('hidden');
        renderAdminLists();
    }
}

// --- PROFIL ---
function showProfile() {
    if (!currentState.user) return;
    const u = currentState.user;
    
    const html = `
        <div style="line-height: 1.6;">
            Ime in priimek: <span class="bold">${u.name}</span><br>
            Uporabniško ime: <span class="bold">${u.username}</span><br>
            Geslo: <span class="bold"><input type="text" id="profile-pass" value="${u.password}" style="width:120px"></span><br>
            Zadnja prijava: <span class="bold">${db.lastLogin.time}</span><br>
            Številka licence: <span class="bold">SI-882190</span><br>
            Dovoljen čas seje: <span class="bold">${u.sessionTimeout || 15} min</span>
        </div>
    `;
    
    showModal("Osebni profil", html, [
        { 
            label: 'Shrani geslo', 
            onClick: () => {
                const newPass = document.getElementById('profile-pass').value;
                currentState.user.password = newPass;
                const idx = db.users.findIndex(us => us.id === currentState.user.id);
                if(idx !== -1) db.users[idx].password = newPass;
                saveDB();
                customAlert("Geslo posodobljeno!");
            }
        },
        { label: 'Zapri', onClick: closeModal }
    ]);
}

// --- ADMIN LOGIC ---
function checkAdminAndShowData() {
    const html = `<label>Vpiši ADMIN geslo:</label><input type="password" id="admin-auth-pass">`;
    showModal("Admin prijava", html, [
        {
            label: 'Potrdi',
            onClick: () => {
                const val = document.getElementById('admin-auth-pass').value;
                if (val === "ADMIN") {
                    closeModal();
                    showPage('podatki');
                } else {
                    customAlert("Napačno geslo!");
                }
            },
            shouldClose: false
        },
        { label: 'Prekliči', onClick: closeModal }
    ]);
}

function renderAdminLists() {
    const tList = document.getElementById('list-teachers');
    tList.innerHTML = db.users.map(u => 
        `<li>
            <span>${u.name} (${u.role === 'admin' ? 'ADMIN' : 'Učitelj'})</span>
            <div>
                <button class="win-btn mini-btn" onclick="editTeacher(${u.id})">Uredi</button>
                <button class="win-btn mini-btn" onclick="deleteUser(${u.id})">X</button>
            </div>
         </li>`
    ).join('');

    const cList = document.getElementById('list-classes');
    cList.innerHTML = db.classes.map(c => 
        `<li>${c.name} <div><button class="win-btn mini-btn" onclick="manageClass(${c.id})">Uredi</button> <button class="win-btn mini-btn" onclick="deleteClass(${c.id})">X</button></div></li>`
    ).join('');

    const sList = document.getElementById('list-subjects');
    sList.innerHTML = db.subjects.map(s => 
        `<li>${s.name} <button class="win-btn mini-btn" onclick="deleteSubject(${s.id})">X</button></li>`
    ).join('');
}

function addTeacher() { openTeacherModal(); }

function editTeacher(id) {
    const user = db.users.find(u => u.id === id);
    if(user) openTeacherModal(user);
}

function openTeacherModal(user = null) {
    const isEdit = !!user;
    const title = isEdit ? "Urejanje učitelja" : "Dodajanje učitelja";
    
    const html = `
        <label>Ime in priimek:</label>
        <input type="text" id="t-name" value="${isEdit ? user.name : ''}">
        <label>Uporabniško ime:</label>
        <input type="text" id="t-user" value="${isEdit ? user.username : ''}">
        <label>Geslo:</label>
        <input type="text" id="t-pass" value="${isEdit ? user.password : ''}">
        <label>Čas seje (min):</label>
        <input type="number" id="t-time" value="${isEdit ? (user.sessionTimeout || 15) : '15'}">
    `;

    showModal(title, html, [
        {
            label: 'Shrani',
            onClick: () => {
                const name = document.getElementById('t-name').value;
                const username = document.getElementById('t-user').value;
                const password = document.getElementById('t-pass').value;
                const timeout = parseInt(document.getElementById('t-time').value) || 15;

                if(!name || !username || !password) {
                    customAlert("Vsa polja so obvezna!");
                    return;
                }

                if (isEdit) {
                    const idx = db.users.findIndex(u => u.id === user.id);
                    db.users[idx] = { ...db.users[idx], name, username, password, sessionTimeout: timeout };
                } else {
                    db.users.push({ id: Date.now(), name, username, password, sessionTimeout: timeout, role: 'teacher' });
                }
                saveDB();
                renderAdminLists();
                closeModal();
            },
            shouldClose: false
        },
        { label: 'Prekliči', onClick: closeModal }
    ]);
}

function deleteUser(id) {
    const u = db.users.find(x => x.id === id);
    if(u.role === 'admin') { customAlert("Admina ni mogoče izbrisati!"); return; }
    
    customConfirm("Res želiš izbrisati tega uporabnika?", () => {
        db.users = db.users.filter(x => x.id !== id);
        saveDB();
        renderAdminLists();
        closeModal();
    });
}

function addClass() {
    customPrompt("Ime razreda (npr. 1.A):", (name) => {
        if(name) {
            db.classes.push({ id: Date.now(), name, students: [] });
            saveDB();
            renderAdminLists();
            closeModal();
        }
    });
}

function deleteClass(id) {
    customConfirm("Izbrišem razred?", () => {
        db.classes = db.classes.filter(c => c.id !== id);
        saveDB();
        renderAdminLists();
        closeModal();
    });
}

function addSubject() {
    customPrompt("Ime predmeta:", (name) => {
        if(name) {
            db.subjects.push({ id: Date.now(), name });
            saveDB();
            renderAdminLists();
            closeModal();
        }
    });
}

function deleteSubject(id) {
    customConfirm("Izbrišem predmet?", () => {
        db.subjects = db.subjects.filter(s => s.id !== id);
        saveDB();
        renderAdminLists();
        closeModal();
    });
}

function manageClass(classId) {
    const cls = db.classes.find(c => c.id === classId);
    
    function renderClassModalContent() {
        let html = `<ul class="admin-list" style="max-height: 200px;">`;
        cls.students.forEach(s => {
            html += `<li>
                <span onclick="showStudentDetails(${classId}, ${s.id})" style="cursor:pointer; text-decoration:underline;">${s.name}</span> 
                <button class="win-btn mini-btn" onclick="removeStudent(${classId}, ${s.id})">X</button>
            </li>`;
        });
        html += `</ul>`;
        return html;
    }

    showModal(`Urejanje: ${cls.name}`, renderClassModalContent(), [
        { 
            label: 'Dodaj učenca', 
            onClick: () => {
                closeModal();
                setTimeout(() => {
                    customPrompt("Ime in priimek učenca:", (sName) => {
                        if (sName) {
                            const cleanName = sName.toLowerCase().replace(/\s/g, '');
                            cls.students.push({
                                id: Date.now(), name: sName, username: cleanName, password: cleanName, access: true
                            });
                            saveDB();
                        }
                        manageClass(classId);
                    });
                }, 100);
            },
            shouldClose: false
        },
        {
            label: 'Ponastavi ocene',
            onClick: () => {
                closeModal();
                setTimeout(() => {
                    customConfirm("Izbrišem vse ocene tega razreda?", () => {
                        const studentIds = cls.students.map(s => s.id);
                        db.grades = db.grades.filter(g => !studentIds.includes(g.studentId));
                        db.warnings = db.warnings.filter(w => !studentIds.includes(w.studentId));
                        saveDB();
                        manageClass(classId);
                    });
                }, 100);
            },
            shouldClose: false
        },
        { label: 'Zapri', onClick: closeModal }
    ]);
    
    window.removeStudent = function(cId, sId) {
        const c = db.classes.find(x => x.id === cId);
        c.students = c.students.filter(x => x.id !== sId);
        saveDB();
        closeModal();
        setTimeout(() => manageClass(cId), 50);
    };
    
    window.showStudentDetails = function(cId, sId) {
        const c = db.classes.find(x => x.id === cId);
        const s = c.students.find(x => x.id === sId);
        const subjectList = db.subjects.map(sub => sub.name).join(", ");
        
        const info = `
            <p>Ime in priimek: <span class="bold">${s.name}</span></p>
            <p>Vpisan v razred: <span class="bold">${c.name}</span></p>
            <p>Pri predmetih: ${subjectList}</p>
            <p>Uporabniško ime: <span class="bold">${s.username}</span></p>
            <p>Geslo: <span class="bold">${s.password}</span></p>
            <p>Dostopnost: <span class="bold">${s.access ? 'DA' : 'NE'}</span></p>
        `;
        closeModal();
        setTimeout(() => {
            showModal("Podatki o učencu", info, [
                { label: 'Nazaj', onClick: () => { closeModal(); manageClass(cId); } }
            ]);
        }, 100);
    };
}


function resetAllData() {
    customConfirm("POZOR! To bo izbrisalo VSE podatke. Nadaljujem?", () => {
        localStorage.removeItem('mindex_db');
        location.reload();
    });
}

// --- REDOVALNICA ---
function loadRedovalnicaDropdowns() {
    const cSel = document.getElementById('sel-class');
    const sSel = document.getElementById('sel-subject');
    cSel.innerHTML = '<option value="">Izberi razred</option>' + db.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    sSel.innerHTML = '<option value="">Izberi predmet</option>' + db.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
}

function setGradeType(type) {
    currentState.selectedGradeType = type;
    document.querySelectorAll('.grade-type-btn').forEach(b => b.classList.remove('selected-type'));
    document.querySelector(`.btn-${type.toLowerCase()}`).classList.add('selected-type');
}

/**
 * GLAVNA FUNKCIJA ZA PRIKAZ OCEN
 * Vključuje logiko za deljen pogled (Split View) in Tooltipe
 */
function renderGradebook() {
    const classId = parseInt(document.getElementById('sel-class').value);
    const subjectId = parseInt(document.getElementById('sel-subject').value);
    const viewMode = document.getElementById('sel-view').value; // 'TEACHERS' ali 'STUDENTS'
    const tbody = document.getElementById('gradebook-body');
    tbody.innerHTML = '';
    
    if (!classId || !subjectId) return;
    
    currentState.selectedClassId = classId;
    currentState.selectedSubjectId = subjectId;
    const cls = db.classes.find(c => c.id === classId);
    
    cls.students.forEach(student => {
        const tr = document.createElement('tr');
        const tdName = `<td>${student.name}</td>`;
        
        // Funkcija za generiranje HTML-ja posameznih ocen
        const generateGradesHtml = (gradeList) => {
            let h = '';
            gradeList.forEach(g => {
                let cls = g.type === 'PISNO' ? 'grade-pisno' : (g.type === 'IZDELEK' ? 'grade-izdelek' : 'grade-ustno');
                let val = g.correction ? `<span class="${cls}"><span class="grade-correction">${g.value}</span>${g.correction}</span>` : `<span class="${cls}">${g.value}</span>`;
                
                // TOOLTIP: Kdo in kdaj
                const tooltip = `Vpisal: ${g.authorName || 'Neznano'}\nDatum: ${g.date || 'Neznano'}`;
                
                h += `<span class="grade-span" title="${tooltip}" onclick="editGrade(${g.id}); event.stopPropagation();">${val}</span>`;
            });
            return h;
        };

        const renderCellContent = (period) => {
            const allGrades = db.grades.filter(g => g.studentId === student.id && g.subjectId === subjectId && g.period === period && !g.isFinal);
            
            if (viewMode === 'STUDENTS') {
                // Enostaven pogled (vse skupaj)
                return `<div class="single-view" onclick="addNewGrade(${student.id}, ${subjectId}, ${period})">
                            ${generateGradesHtml(allGrades)}
                        </div>`;
            } else {
                // Pogled UČITELJI: Razdeli na MOJE in OSTALE
                const myGrades = allGrades.filter(g => g.authorId === currentState.user.id);
                // Ocene drugih ali stare ocene brez ID-ja
                const otherGrades = allGrades.filter(g => g.authorId !== currentState.user.id);

                return `<div class="split-container">
                            <div class="split-top" onclick="addNewGrade(${student.id}, ${subjectId}, ${period})">
                                ${generateGradesHtml(myGrades)}
                            </div>
                            <div class="split-bottom" onclick="addNewGrade(${student.id}, ${subjectId}, ${period})">
                                ${generateGradesHtml(otherGrades)}
                            </div>
                        </div>`;
            }
        };
        
        // Graje in končne ocene ostanejo enake
        const getWarnHtml = (period) => {
            const w = db.warnings.find(x => x.studentId === student.id && x.subjectId === subjectId && x.period === period);
            if(!w) return '';
            return w.type === 'x' ? '<img src="nok.png" class="icon-img" alt="X">' : '<img src="ok.png" class="icon-img" alt="OK">';
        };

        const getFinalHtml = () => {
            const g = db.grades.find(x => x.studentId === student.id && x.subjectId === subjectId && x.isFinal);
            if(!g) return '';
            const tooltip = `Vpisal: ${g.authorName || 'Neznano'}\nDatum: ${g.date || 'Neznano'}`;
            return `<span title="${tooltip}" onclick="editFinalGrade(${g.id}); event.stopPropagation();">${g.value}</span>`;
        };

        tr.innerHTML = `
            ${tdName}
            <td class="grade-cell">${renderCellContent(1)}</td>
            <td class="grade-cell" onclick="handleWarning(${student.id}, ${subjectId}, 1)">${getWarnHtml(1)}</td>
            <td class="grade-cell">${renderCellContent(2)}</td>
            <td class="grade-cell" onclick="handleWarning(${student.id}, ${subjectId}, 2)">${getWarnHtml(2)}</td>
            <td class="grade-cell" onclick="addFinalGrade(${student.id}, ${subjectId})">${getFinalHtml()}</td>
        `;
        tbody.appendChild(tr);
    });
}

function addNewGrade(studentId, subjectId, period) {
    const html = `
        <label>Vpiši oceno (${currentState.selectedGradeType}):</label>
        <input type="text" id="new-grade-val" style="width: 60px;" autofocus>
    `;
    showModal("Vnos ocene", html, [
        {
            label: 'Potrdi',
            onClick: () => {
                const val = document.getElementById('new-grade-val').value;
                if(val) {
                    db.grades.push({ 
                        id: Date.now(), 
                        studentId, 
                        subjectId, 
                        period, 
                        type: currentState.selectedGradeType, 
                        value: val, 
                        correction: null, 
                        isFinal: false,
                        // DODANO: Podatki o avtorju
                        authorId: currentState.user.id,
                        authorName: currentState.user.name,
                        date: new Date().toLocaleDateString('sl-SI')
                    });
                    saveDB();
                    renderGradebook();
                    closeModal();
                }
            },
            shouldClose: false
        },
        { label: 'Prekliči', onClick: closeModal }
    ]);
    
    setTimeout(() => {
        document.getElementById('new-grade-val').addEventListener("keyup", (e) => {
            if(e.key === "Enter") document.getElementById('modal-btn-0').click();
        });
    }, 100);
}

function editGrade(gradeId) {
    const grade = db.grades.find(g => g.id === gradeId);
    // Info o oceni v oknu za urejanje
    const info = `<div style="font-size:11px; margin-bottom:10px; color:#555;">Vpisal: ${grade.authorName || '?'}, dne: ${grade.date || '?'}</div>`;

    const html = `
        ${info}
        <label>Ocena:</label><input type="text" id="eg-val" value="${grade.value}" style="width:50px">
        <label>Popravek:</label><input type="text" id="eg-corr" value="${grade.correction || ''}" style="width:50px">
    `;
    showModal("Urejanje ocene", html, [
        {
            label: 'Shrani',
            onClick: () => {
                const val = document.getElementById('eg-val').value;
                const corr = document.getElementById('eg-corr').value;
                const idx = db.grades.findIndex(g => g.id === gradeId);
                if(!val) db.grades.splice(idx, 1);
                else {
                    db.grades[idx].value = val;
                    db.grades[idx].correction = corr ? corr : null;
                }
                saveDB();
                renderGradebook();
                closeModal();
            },
            shouldClose: false
        }
    ]);
}

function handleWarning(studentId, subjectId, period) {
    const cls = db.classes.find(c => c.id === currentState.selectedClassId);
    const student = cls.students.find(s => s.id === studentId);
    const existing = db.warnings.find(w => w.studentId === studentId && w.subjectId === subjectId && w.period === period);

    if (!existing) {
        const msg = `Želite učencu <span class="bold">${student.name}</span> zabeležiti grajo <img src="nok.png" style="height:20px; vertical-align:middle;">?`;
        customConfirm(msg, () => {
            db.warnings.push({ studentId, subjectId, period, type: 'x' });
            saveDB();
            renderGradebook();
            closeModal();
        });
    } else {
        const html = `<p>Želite učencu <span class="bold">${student.name}</span> zabeležiti naknadno opravljene obveznosti <img src="ok.png" style="height:20px; vertical-align:middle;"> ali grajo izbrisati?</p>`;
        showModal("Urejanje", html, [
            { 
                label: 'Spremeni', 
                onClick: () => { 
                    existing.type = 'check'; 
                    saveDB(); renderGradebook(); closeModal(); 
                } 
            },
            { 
                label: 'Izbriši', 
                onClick: () => { 
                    db.warnings = db.warnings.filter(w => w !== existing); 
                    saveDB(); renderGradebook(); closeModal(); 
                } 
            },
            { label: 'Zapri', onClick: closeModal }
        ]);
    }
}

function addFinalGrade(studentId, subjectId) {
    const existing = db.grades.find(g => g.studentId === studentId && g.subjectId === subjectId && g.isFinal);
    if(existing) return;
    
    const html = `<label>Končna ocena:</label><input type="text" id="final-val" style="width:50px">`;
    showModal("Končna ocena", html, [
        {
            label: 'Potrdi',
            onClick: () => {
                const val = document.getElementById('final-val').value;
                if(val) {
                    db.grades.push({ 
                        id: Date.now(), 
                        studentId, 
                        subjectId, 
                        isFinal: true, 
                        value: val, 
                        type: 'FINAL',
                        authorId: currentState.user.id,
                        authorName: currentState.user.name,
                        date: new Date().toLocaleDateString('sl-SI')
                    });
                    saveDB(); renderGradebook(); closeModal();
                }
            },
            shouldClose: false
        }
    ]);
}

function editFinalGrade(gradeId) {
    const g = db.grades.find(x => x.id === gradeId);
    const html = `<label>Končna ocena:</label><input type="text" id="ef-val" value="${g.value}" style="width:50px">`;
    showModal("Uredi končno", html, [
        {
            label: 'Shrani',
            onClick: () => {
                const val = document.getElementById('ef-val').value;
                const idx = db.grades.findIndex(x => x.id === gradeId);
                if(!val) db.grades.splice(idx, 1);
                else db.grades[idx].value = val;
                saveDB(); renderGradebook(); closeModal();
            },
            shouldClose: false
        }
    ]);
}

function openBulkEntry() {
    if (!currentState.selectedClassId || !currentState.selectedSubjectId) {
        customAlert("Najprej izberi razred in predmet!");
        return;
    }
    const cls = db.classes.find(c => c.id === currentState.selectedClassId);
    let rows = cls.students.map(s => 
        `<div class="bulk-list-item" style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span>${s.name}</span>
            <input type="text" class="bulk-inp" data-sid="${s.id}" style="width:50px;">
         </div>`
    ).join('');
    
    const html = `
        <label>Tip:</label>
        <select id="bulk-type"><option value="USTNO">USTNO</option><option value="PISNO">PISNO</option><option value="IZDELEK">IZDELEK</option></select>
        <label>Obdobje:</label>
        <select id="bulk-per"><option value="1">1.</option><option value="2">2.</option></select>
        <div style="max-height:150px; overflow-y:auto; border:1px solid #999; padding:5px; margin-top:10px;">${rows}</div>
    `;

    showModal("Množični vpis", html, [
        {
            label: 'Shrani',
            onClick: () => {
                const type = document.getElementById('bulk-type').value;
                const per = parseInt(document.getElementById('bulk-per').value);
                const now = new Date().toLocaleDateString('sl-SI');
                document.querySelectorAll('.bulk-inp').forEach(inp => {
                    const val = inp.value.trim();
                    const sid = parseInt(inp.getAttribute('data-sid'));
                    if(val) {
                        db.grades.push({ 
                            id: Date.now() + Math.random(), 
                            studentId: sid, 
                            subjectId: currentState.selectedSubjectId, 
                            period: per, 
                            type, 
                            value: val, 
                            correction: null, 
                            isFinal: false,
                            authorId: currentState.user.id,
                            authorName: currentState.user.name,
                            date: now
                        });
                    }
                });
                saveDB(); renderGradebook(); closeModal();
            },
            shouldClose: false
        },
        { label: 'Prekliči', onClick: closeModal }
    ]);
}

init();
</script>


</body></html>
